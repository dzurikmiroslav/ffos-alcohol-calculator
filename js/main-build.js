!function(e,t){"use strict";var n=t.module("app",["ngRoute","ngAnimate","ngTouch","appLocale"]);n.config(["$locationProvider","$routeProvider",function(e,t){e.html5Mode(!1),t.when("/",{templateUrl:"views/dashboard.html",controller:"dashboardController",animation:null,level:0}).when("/settings",{templateUrl:"views/settings.html",controller:"settingsController",animation:"raise-anim",level:1}).when("/drinking",{templateUrl:"views/drinking.html",controller:"createDrinkingController",animation:"slide-anim",level:2}).when("/drinking/:id",{templateUrl:"views/drinking.html",controller:"updateDrinkingController",animation:"slide-anim",level:2}).when("/presets",{templateUrl:"views/presets.html",controller:"presetsController",animation:"slide-anim",level:1}).when("/preset",{templateUrl:"views/preset.html",controller:"createPresetController",animation:"slide-anim",level:2}).when("/preset/:id",{templateUrl:"views/preset.html",controller:"updatePresetController",animation:"slide-anim",level:2}).when("/about",{templateUrl:"views/about.html",controller:"aboutController",animation:"slide-anim",level:1}).otherwise({redirectTo:"/"})}]),n.controller("AppCtrl",["$scope","$rootScope","$window","$location","$document","$http",function(e,n,a,r){var o=a.localStorage.getItem("profile");n.profile=o?t.fromJson(o):{weight:75,gender:"m"},n.$watch("profile",function(){a.localStorage.setItem("profile",t.toJson(n.profile))}),r.path("/"),e.animation="",e.go=function(e){r.path(e)},e.goBack=function(){a.history.back()},e.$on("$routeChangeStart",function(t,n,a){n&&a&&(e.animation=n.level<a.level?a?a.animation+"-reverse":"":n?n.animation:"")})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.directive("chart",["$window","$filter",function(e,t){function n(e){var t=e.axisCanvas,n=t.getContext("2d");n.save(),n.setTransform(e.ratio,0,0,e.ratio,0,.5,.5),n.clearRect(-.5,-.5,31,225),n.font="14px MozTT, sans-serif",n.fillStyle="#424242",n.fillText("3\u2030",0,26),n.fillText("2\u2030",0,76),n.fillText("1\u2030",0,126),n.fillText("0\u2030",0,176),n.restore()}function a(e){function n(e,t,n,a){g.beginPath(),g.moveTo(e,t),g.lineTo(n,a),g.stroke()}function a(e){return Math.round((e-s)/36e5*10)}var r,o,i,l,s=e.data.startDate,u=e.data.endDate,c=e.data.currentDate,d=e.data.currentValue,f=e.data.values,g=e.chartCanvas.getContext("2d");for(g.save(),g.setTransform(e.ratio,0,0,e.ratio,0,.5,.5),g.clearRect(-.5,-.5,7440,225),g.font="14px MozTT, sans-serif",g.strokeStyle="#e7e7e7",n(0,30,7440,30),n(0,80,7440,80),n(0,130,7440,130),n(0,180,7440,180),g.strokeStyle="#e7e7e7",g.fillStyle="#424242",l=s;u>=l;){r=new Date(l);var p=r.getHours(),v=p%4===0;o=a(l),v&&(g.textAlign=l===s?"start":l===u?"end":"center",g.fillText(t("date")(l,"HH"),o,203)),n(o,185,o,v?0:180),l+=36e5}for(r=new Date(s),r.setHours(12),r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),g.fillStyle="#404040",g.textAlign="center",l=r.getTime();u>=l;)o=a(l),g.fillText(t("date")(l,"mediumDate"),o,220),l+=864e5;g.strokeStyle="#bbda00",g.fillStyle="rgba(187, 218, 0, 0.25)",g.lineWidth=2;var m=0;for(l in f){var h=f[l];(0!==h.value||0!==m)&&g.lineTo(a(h.date),180-50*h.value),0===h.value&&(0===m?(g.beginPath(),g.moveTo(a(h.date),180)):(g.fill(),g.stroke())),m=h.value}o=a(c),i=180,g.fillStyle="#25abcf",g.beginPath(),g.moveTo(o,i),g.lineTo(o-5,i+10),g.lineTo(o+5,i+10),g.fill(),g.lineWidth=1,g.strokeStyle="#25abcf",n(o,190,o,0),d>0&&(g.beginPath(),g.fillStyle="#fff",g.lineWidth=2,g.arc(a(c),180-50*d,4,0,2*Math.PI),g.fill(),g.strokeStyle="#25abcf",g.stroke()),g.restore()}function r(t,r){t.chartReady=!1;var o=r.find("article")[0],i=r.find("canvas");t.axisCanvas=i[0],t.chartCanvas=i[1];var l=e.devicePixelRatio||1,s=t.axisCanvas.getContext("2d"),u=s.webkitBackingStorePixelRatio||s.mozBackingStorePixelRatio||s.backingStorePixelRatio||1;t.ratio=l/u,t.$watch(function(){return t.data?{startDate:t.data.startDate,endDate:t.data.endDate,values:t.data.values,currentDate:t.data.currentDate,currentValue:t.data.currentValue}:t.data},function(){t.data&&(t.chartReady||(n(t),o.scrollLeft=o.scrollWidth-o.clientWidth-130),a(t),t.chartReady=!0)},!0)}return{restrict:"E",replace:!0,transclude:!1,link:r,scope:{data:"=data"},templateUrl:"templates/chart.html"}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.filter("translate",["locale",function(e){return function(t){return e.MESSAGES[t]}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.filter("deltaTime",["locale",function(e){return function(t){var n=Math.floor(t/864e5);t-=864e5*n;var a=Math.floor(t/36e5);t-=36e5*a;var r=Math.floor(t/6e4),o=[];return n&&o.push(n,e.getPlural(n,"DAY")),a&&(n&&o.push(e.MESSAGES.AND),o.push(a,e.getPlural(a,"HOUR"))),n||(a&&o.push(e.MESSAGES.AND),o.push(r,e.getPlural(r,"MINUTE"))),o.join(" ")}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.factory("database",["$q","$log","$window",function(e,t,n){function a(e){if(b)e();else if(k=n.indexedDB||n.webkitIndexedDB||n.mozIndexedDB||n.msIndexedDB,w=n.IDBKeyRange||n.webkitIDBKeyRange||n.mozIDBKeyRange||n.msIDBKeyRange,k){var a=k.open(D,S);a.onerror=function(e){t.error(e)},a.onsuccess=function(){b=a.result,b.onerror=function(e){t.error(e)},e()},a.onupgradeneeded=r}else t.error("IndexedDB is not available")}function r(e){t.log("Upgrading db");var n=e.target.result,a=n.createObjectStore("drinkings",{keyPath:"id",autoIncrement:!0});a.createIndex("date","date",{unique:!1}),a=n.createObjectStore("drinks",{keyPath:"id",autoIncrement:!0}),a.createIndex("name","name",{unique:!0}),t.log("Upgrading db done")}function o(e,t,n){var a=b.transaction(e,t);return a.onerror=function(e){n.reject(e.target.error)},a.objectStore(e)}function i(t,n){var r=e.defer();return a(function(){var e=[],a=w.bound(t,n,!0,!0);o("drinkings","readonly",r).index("date").openCursor(a,"next").onsuccess=function(t){var n=t.target.result;n?(e.push(n.value),n.continue()):r.resolve(e)}}),r.promise}function l(t,n){var r=e.defer();return a(function(){var e=[];o("drinkings","readonly",r).index("date").openCursor(null,"prev").onsuccess=function(a){var o=a.target.result;t?(o.advance(t),t=0):o&&e.length<n?(e.push(o.value),o.continue()):(e.hasNextPage=!!o,r.resolve(e))}}),r.promise}function s(t){var n=e.defer();return a(function(){var e=o("drinkings","readonly",n);e.get(t).onsuccess=function(e){n.resolve(e.target.result)}}),n.promise}function u(t){var n=e.defer();return a(function(){var e=o("drinkings","readwrite",n);e.transaction.oncomplete=function(e){n.resolve(e.target.result)},e.add(t)}),n.promise}function c(t){var n=e.defer();return a(function(){var e=o("drinkings","readwrite",n);e.transaction.oncomplete=function(){n.resolve()},e.put(t)}),n.promise}function d(t){var n=e.defer();return a(function(){var e=o("drinkings","readwrite",n);e.transaction.oncomplete=function(){n.resolve()},e.delete(t)}),n.promise}function f(){var t=e.defer();return a(function(){var e=[];o("drinks","readonly",t).index("name").openCursor(null,"next").onsuccess=function(n){var a=n.target.result;a?(e.push(a.value),a.continue()):t.resolve(e)}}),t.promise}function g(t){var n=e.defer();return a(function(){var e=o("drinks","readonly",n);e.get(t).onsuccess=function(e){n.resolve(e.target.result)}}),n.promise}function p(t){var n=e.defer();return a(function(){o("drinks","readonly",n).index("name").get(t).onsuccess=function(e){n.resolve(void 0!==e.target.result)}}),n.promise}function v(t){var n=e.defer();return a(function(){var e=o("drinks","readwrite",n);e.transaction.oncomplete=function(e){n.resolve(e.target.result)},e.add(t)}),n.promise}function m(t){var n=e.defer();return a(function(){var e=o("drinks","readwrite",n);e.transaction.oncomplete=function(){n.resolve()},e.put(t)}),n.promise}function h(t){var n=e.defer();return a(function(){var e=o("drinks","readwrite",n);e.transaction.oncomplete=function(){n.resolve()},e.delete(t)}),n.promise}var k,w,D="DrinkLog",S=1,b=null;return{getDrinkingsByPage:l,getDrinkingsByRange:i,getDrinking:s,createDrinking:u,updateDrinking:c,deleteDrinking:d,getDrinks:f,getDrink:g,createDrink:v,updateDrink:m,deleteDrink:h,hasDrink:p}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.factory("calculator",["$rootScope",function(e){function t(t){var n=e.profile.weight*("m"===e.profile.gender?.7:.6),r=e.profile.weight*("m"===e.profile.gender?.1:.085),o=0,i=0,l=0,s=[];for(var u in t){var c=t[u],d=c.volume*(c.alcoholContent/100)*.8,f=(c.date-i)/36e5;if(o=Math.max(o-r*f,0),0===o&&l<c.date-a)l&&(s.push({date:l,value:0}),l=0),s.push({date:c.date-a,value:0});else if(c.date-i>a){var g=Math.max(o-r*(a/36e5),0);s.push({date:c.date-a,value:g/n})}o+=d,i=c.date,l=i+Math.round(o/r*36e5),s.push({date:i,value:o/n})}return l&&s.push({date:l,value:0}),s}function n(e,t){var n=t.getTime(),a=null,r=null,o=null;for(var i in e){var l=e[i];a?l.date>a.date&&l.date<=n&&(a=l):l.date<=n&&(a=l),r?l.date<r.date&&l.date>=n&&(r=l):l.date>=n&&(r=l),o?l.date>o.date&&(o=l):o=l}var s={date:n};if(a&&r){var u=r.date-a.date,c=r.value-a.value,d=(n-a.date)/u;s.value=a.value+d*c}else s.value=0;return o?o.date>n?(s.closingDate=o.date,s.deltaEmptyDate=0):(s.closingDate=0,s.deltaEmptyDate=n-o.date):(s.closingDate=0,s.deltaEmptyDate=0),s}var a=6e5;return{createCourse:t,getState:n}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.factory("modal",["$document","$timeout",function(e,n){function a(a){var r=e.find("body"),o=t.element("<section role='status' class='onviewport'><p>"+a+"</p></section>");r.append(o),n(function(){o.removeClass("onviewport"),n(function(){o.remove()},300)},2e3)}return{status:a}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("dashboardController",["$scope","$rootScope",function(e,t){e.tab=t.dahsboardTab?t.dahsboardTab:"chart",e.loadedChartTab=!1,e.loadedListTab=!1,e.$watch("tab",function(n){switch(t.dahsboardTab=n,n){case"chart":e.loadedChartTab=!0;break;case"list":e.loadedListTab=!0}})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("dashboardChartController",["$scope","$interval","database","calculator",function(e,t,n,a){function r(){o(),e.state=a.getState(e.course,new Date),e.chartData.currentDate=e.state.date,e.chartData.currentValue=e.state.value}function o(){var t=new Date;t.setDate(t.getDate()-30),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),e.startDate=t.getTime(),t.setDate(t.getDate()+31),e.endDate=t.getTime()}o(),n.getDrinkingsByRange(e.startDate,e.endDate).then(function(n){e.course=a.createCourse(n),e.chartData={values:e.course,startDate:e.startDate,endDate:e.endDate},r();var o=t(r,6e4);e.$on("$destroy",function(){t.cancel(o)})})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("dashboardListController",["$scope","database",function(e,t){e.hasNextPage=!1;var n=20;e.pageStart=n,t.getDrinkingsByPage(0,n).then(function(t){e.drinkings=t,e.hasNextPage=t.hasNextPage}),e.isNextDay=function(e,t){return Math.abs(t-e)>864e5?!0:new Date(e).getDay()!==new Date(t).getDay()},e.fetchDrinkingsNextPage=function(){t.getDrinkingsByPage(e.pageStart,n).then(function(t){e.drinkings=e.drinkings.concat(t),e.pageStart+=n,e.hasNextPage=t.hasNextPage})}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("settingsController",["$scope","$rootScope",function(e,n){e.profile=t.copy(n.profile),e.save=function(){n.profile=e.profile,e.goBack()}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("aboutController",["$scope","$filter","modal",function(t,n,a){if(t.hasMozApps=!!e.navigator.mozApps,"mozApps"in e.navigator){var r=e.navigator.mozApps.getSelf();r.onsuccess=function(){console.log(r),t.isInstalled=!!r.result,t.$apply()}}t.install=function(){var r=e.location.href.replace(e.location.hash,"");r=r.substr(0,r.lastIndexOf("/"));var o=r+"/manifest.webapp",i=e.navigator.mozApps.install(o);i.onsuccess=function(){t.isInstalled=!0,t.$apply(),a.status(n("translate")("INSTALL_SUCCESS"))},i.onerror=function(){a.status(n("translate")("INSTALL_FAILED")),console.log(i)}}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("createDrinkingController",["$scope","$filter","database","modal",function(e,t,n,a){function r(){n.getDrinks().then(function(t){e.drinks=t})}e.isUpdate=!1,e.drinking={},e.date=new Date,e.time=new Date,e.drinkExist=!1,r(),e.setDrink=function(t){e.drinking.drinkName=t.name,e.drinking.volume=t.volume,e.drinking.alcoholContent=t.alcoholContent},e.save=function(){var t=new Date(e.date.getTime());t.setHours(e.time.getHours()),t.setMinutes(e.time.getMinutes()),t.setSeconds(e.time.getSeconds()),e.drinking.date=t.getTime(),n.createDrinking(e.drinking).then(e.goBack)},e.savePreset=function(){var o={name:e.drinking.drinkName,volume:e.drinking.volume,alcoholContent:e.drinking.alcoholContent};n.createDrink(o).then(function(){e.drinkExist=!0,a.status(t("translate")("DRINK_PRESET_WAS_CREATED")),r()})},e.$watch("drinking.drinkName",function(t){t&&n.hasDrink(t).then(function(t){e.drinkExist=t})})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("updateDrinkingController",["$scope","$routeParams","$filter","database","modal",function(e,t,n,a,r){function o(){a.getDrinks().then(function(t){e.drinks=t})}e.isUpdate=!0,e.drinkExist=!1,a.getDrinking(parseInt(t.id)).then(function(t){e.drinking=t,e.date=new Date(t.date),e.time=new Date(t.date)}),o(),e.setDrink=function(t){e.drinking.drinkName=t.name,e.drinking.volume=t.volume,e.drinking.alcoholContent=t.alcoholContent},e.save=function(){var t=new Date(e.date.getTime());t.setHours(e.time.getHours()),t.setMinutes(e.time.getMinutes()),t.setSeconds(e.time.getSeconds()),e.drinking.date=t.getTime(),a.updateDrinking(e.drinking).then(e.goBack)},e.savePreset=function(){var t={name:e.drinking.drinkName,volume:e.drinking.volume,alcoholContent:e.drinking.alcoholContent};a.createDrink(t).then(function(){e.drinkExist=!0,r.status(n("translate")("DRINK_PRESET_WAS_CREATED")),o()})},e.delete=function(){a.deleteDrinking(e.drinking.id).then(e.goBack)},e.$watch("drinking.drinkName",function(t){t&&a.hasDrink(t).then(function(t){e.drinkExist=t})})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("presetsController",["$scope","database",function(e,t){t.getDrinks().then(function(t){e.drinks=t})}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("createPresetController",["$scope","$filter","database","modal",function(e,t,n,a){e.isUpdate=!1,e.drink={},e.save=function(){n.createDrink(e.drink).then(e.goBack,function(e){"ConstraintError"===e.name&&a.status(t("translate")("DRINK_PRESET_WITH_NAME_EXISTS"))})}}])}(window,window.angular),function(e,t){"use strict";var n=t.module("app");n.controller("updatePresetController",["$scope","$routeParams","$filter","database","modal",function(e,t,n,a,r){e.isUpdate=!0,a.getDrink(parseInt(t.id)).then(function(t){e.drink=t}),e.save=function(){a.updateDrink(e.drink).then(e.goBack,function(e){"ConstraintError"===e.name&&r.status(n("translate")("DRINK_PRESET_WITH_NAME_EXISTS"))})},e.delete=function(){a.deleteDrink(e.drink.id).then(e.goBack)}}])}(window,window.angular);